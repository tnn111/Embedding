#!/usr/bin/env python
# /// script
# dependencies = [
#   'numpy',
#   'umap-learn',
#   'hdbscan',
#   'cuml-cu12',
# ]
# ///

import  numpy as np
import  hdbscan

# Try to use GPU-accelerated UMAP, fall back to CPU if unavailable
try:
    from cuml import UMAP
    print('Using GPU-accelerated UMAP (cuML)')
    use_gpu = True
except ImportError:
    from umap import UMAP
    print('Using CPU-based UMAP (umap-learn)')
    use_gpu = False


X_freq = np.loadtxt('./Data/kmer_frequencies_l5000_shuffled.txt', dtype=np.float32)
# X_freq = X_freq[:100000]  # Uncomment to test with 100K sequences first

print(f"Loaded {X_freq.shape[0]} sequences")
print(f"Sum check: {X_freq[0].sum():.6f}")

# Configure UMAP parameters based on GPU/CPU
if use_gpu:
    # GPU version (cuML) - different parameter set
    reducer = UMAP(
        n_components = 32,
        metric = 'cosine',
        n_neighbors = 15,
        min_dist = 0.0,
        verbose = True
    )
else:
    # CPU version (umap-learn) - includes parallelism and memory options
    reducer = UMAP(
        n_components = 32,
        metric = 'cosine',
        n_neighbors = 15,
        min_dist = 0.0,
        n_jobs = 8,
        low_memory = True,
        verbose = True
    )

embedding = reducer.fit_transform(X_freq)
np.save('./Data/umap_32_30_0.npy', embedding)