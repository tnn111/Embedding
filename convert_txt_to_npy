#!/usr/bin/env -S uv run --quiet --script
"""
Convert k-mer frequency text to NumPy binary format (.npy).
Pure filter: reads stdin, writes stdout, messages to stderr.

Input format (from calculate_kmer_frequencies):
    ID length 6-mers(2080) 5-mers(512) 4-mers(136) 3-mers(32) GC
    Total: 2,763 fields per line (1 ID + 2,762 numeric)

Output: NumPy array with 2,762 columns (skipping ID)

Usage:
    cat input_file.txt | convert_txt_to_npy > output_file.npy
    convert_txt_to_npy < input.txt > output.npy
"""
# /// script
# dependencies = [
#   "numpy",
# ]
# ///

import sys
import numpy as np
import io

# Number of numeric columns: length + 6-mers + 5-mers + 4-mers + 3-mers + GC
# = 1 + 2080 + 512 + 136 + 32 + 1 = 2762
NUM_COLUMNS = 2762


def main():
    # Read from stdin
    print('Loading data from stdin...', file = sys.stderr)

    # Load text data and convert to float32 (skip column 0 which is the ID)
    data = np.loadtxt(sys.stdin, usecols = range(1, NUM_COLUMNS + 1), dtype = np.float32)

    print(f'Loaded array with shape {data.shape} and dtype {data.dtype}', file = sys.stderr)

    # Write to stdout as NumPy binary format
    # We need to write to stdout.buffer for binary data
    buffer = io.BytesIO()
    np.save(buffer, data)
    buffer.seek(0)

    sys.stdout.buffer.write(buffer.read())

    print('Conversion complete', file = sys.stderr)


if __name__ == '__main__':
    main()
